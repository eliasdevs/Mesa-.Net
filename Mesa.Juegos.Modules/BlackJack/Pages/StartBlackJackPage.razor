@page "/StartBlackJackPage"
@using Mesa_SV.BlackJack.Helper;
@using Mesa_SV.VoDeJuegos;
@using Newtonsoft.Json;
@using Microsoft.JSInterop
@using Fluxor.Blazor.Web.Components;
@inherits FluxorComponent
@inject IState<BlackJackSore> _store
@inject IDispatcher _dispatcher
@inject NavigationManager _nav
@inject DialogService _dialogservice
@inject IHubConnectionService _hubConnectionService
@inject IJSRuntime JSRuntime

<h3>BlackJackGame</h3>

<hr />
<br />

@if (_store.Value.Loader.IsPlayerTurn)
{
    <p>Es tu turno de Ganar</p>
}
else
{
    <p>Espera que tu contrincante te seda la baraja</p>

        <p style="color: green">Mensaje: <span>@mensaje </span></p>    
}

@if (_store.Value.Loader.BlackJackIsLoading)
{
        <div class="d-flex justify-content-center align-items-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
}
else
{
        <div class="greencloth">
            <div class="container">
      <div id="tapete">
        <span id="barajas-pendientes"></span>

        <div id="cartas-crupier" class="grid"></div><br>
        <div class="contentPuntaje">
          <div class="circulo">
            <div class="texto"><div id="puntaje-crupier"></div></div>
          </div>
          <div class="positionTapete">
          </div>

        </div>

            <button class="btn btn-info" @onclick="() => OnClickReinicarMano()" disabled="@(!_store.Value.Loader.IsPlayerTurn || !ValidButton())">
                Reiniciar
        </button>
                <button class="btn btn-info" id="boton-plantarse" @onclick="() => OnClickPlantarse()" disabled="@(!_store.Value.Loader.IsPlayerTurn || ValidButton())">
                Plantarse
        </button>
                        <button class="btn btn-info" id="boton-pedir-carta" @onclick="() => OnClickPedirCarta()" disabled="@(!_store.Value.Loader.IsPlayerTurn || ValidButton())">
            Pedir carta
        </button>
        <div id="cartas-jugador" class="grid">
                @if (!_store.Value.Loader.IsDrawCard && _store.Value.Mano != null)
                {
                    @foreach (var carta in _store.Value.Mano.Mano)
                    {
                       <card-t rank=@carta.OriginalValue suit="@(Convert.ToInt32(carta.TypeOfCardId))" class="card"></card-t>
                    }
                }
                else if (_store.Value.Loader.IsDrawCard)
                {
                  <div class="d-flex justify-content-center align-items-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando cartas...</span>
                    </div>
                  </div>                        
                }
        </div>
        <div class="contentPuntaje">
          <div class="circulo">
            <div class="texto">
                <div id="puntaje-jugador">
                    @if (_store.Value.Mano != null)
                    {
                        @CalculateManoBlackJack.CalcularPuntuacion(_store.Value.Mano.Mano)    
                    }
                </div>
            </div>
          </div>
          <div class="positionTapete">
            Jugador
          </div>
        </div>
            
      </div>
    </div>
        </div>
    
}
@code{
    private bool ValidButton()
    {
        return (_store.Value.Mano != null && _store.Value.Mano.Estado == StatusHand.STAND_HAND);
    }

    string mensaje = "";
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
    }

    private void calcularGanador(ManoJugadorVo manoRival)
    {
        if (manoRival.Estado == StatusHand.STAND_HAND)
        {
            if (_store.Value.Mano == null)
                return;

            var miMano = _store.Value.Mano;

            //si mi mano no esta plantada no hago nada
            if (miMano.Estado == StatusHand.STAND_HAND)
            {
                //TODO: Calculo para determinar ganador
                if (manoRival != null && manoRival.Mano.Any() && manoRival.Estado == StatusHand.STAND_HAND)
                {
                    if (@CalculateManoBlackJack.CalcularPuntuacion(manoRival.Mano) <= 21)
                    {

                        if ((@CalculateManoBlackJack.CalcularPuntuacion(miMano.Mano) > @CalculateManoBlackJack.CalcularPuntuacion(manoRival.Mano)) &&
                            (@CalculateManoBlackJack.CalcularPuntuacion(miMano.Mano)) <= 21)
                        {
                            mensaje = "Felcidades, Has ganado esta Jugada";
                            //le asigna el turno al jugador
                            _dispatcher.Dispatch(new StartChangeTurn("", true));
                        }
                        else if ((@CalculateManoBlackJack.CalcularPuntuacion(miMano.Mano) == @CalculateManoBlackJack.CalcularPuntuacion(manoRival.Mano)) &&
                    ((@CalculateManoBlackJack.CalcularPuntuacion(miMano.Mano) <= 21) && (@CalculateManoBlackJack.CalcularPuntuacion(manoRival.Mano) <= 21)))
                        {
                            mensaje = "Empate";                        
                        }
                        else if (@CalculateManoBlackJack.CalcularPuntuacion(miMano.Mano) > 21 && @CalculateManoBlackJack.CalcularPuntuacion(manoRival.Mano) > 21)
                        {
                            mensaje = "Ninguno Gana";
                        }
                        else
                        {
                            _dispatcher.Dispatch(new StartChangeTurn("", true));
                            mensaje = "Ups, has perdido";
                        }
                    }

                }
            }
        }
    }

    protected override void OnInitialized()
    {
        HubConnection hubConnection = _hubConnectionService.GetHubConnection();

        //escuche la mano del contrincante
        hubConnection.On<ManoJugadorVo>("GetActiveHandResult", (mano) =>
        {
            calcularGanador(mano);
        });

        //recibo cuando es mi turno
        hubConnection.On<bool>("IsMyTurn", (isMyTurn) =>
        {
            if (_store.Value.BlackjackInfo != null)
                _dispatcher.Dispatch(new StartChangeTurn("", isMyTurn));// me asigna el turno
        });

        //esta es la mano plantada del rival me notifica si se planto
        hubConnection.On<ManoJugadorVo>("InDrawCardStandHand", (mano) =>
        {
            calcularGanador(mano);           
        });

        //recibo una mi mano cada que pido carta
        hubConnection.On<ManoJugadorVo>("DrawCardResult", (mano) =>
        {   
            _dispatcher.Dispatch(new EndDrawCard(mano));

            mensaje = "Vas muy bien";

            //TODO: a esta accion crearle efecto para que le actualice el turno al otro jugador y validar solo si el valor va en false se ejecute
            if (mano.Estado == StatusHand.STAND_HAND)
            {
                if (_store.Value.BlackjackInfo != null)
                    _dispatcher.Dispatch(new StartChangeTurn(_store.Value.BlackjackInfo.IdRequest, false));// mequito el truno
            }
        });
        
        //reinicio mi mano
        hubConnection.On<ManoJugadorVo>("ResetHandResult", (mano) =>
        {
            _dispatcher.Dispatch(new EndResetHand(mano));          
        });

        // escucho y recibo mi mano plantada
        hubConnection.On<ManoJugadorVo>("StandHandResult", (mano) =>
        {   
            _dispatcher.Dispatch(new EndStandHand(mano));
            
            if (_store.Value.BlackjackInfo != null)
                _dispatcher.Dispatch(new StartChangeTurn(_store.Value.BlackjackInfo.IdRequest, false));// mequito el truno

        });


        base.OnInitialized();
    }

      private void OnClickPedirCarta()
    {
        if (_store.Value.BlackjackInfo != null && _store.Value.Request != null)
        {
            string playerId = "";
            if (_store.Value.Loader.IsChallenger)
            {
                //si es retador seteo los datos con el id del retador
                playerId = _store.Value.Request.PlayerId;
            }
            else
            {
                if (!string.IsNullOrEmpty(_store.Value.Request.AcceptedPlayerId))
                {
                    playerId = _store.Value.Request.AcceptedPlayerId;                    
                }                
            }

            if (!string.IsNullOrEmpty(playerId))
                _dispatcher.Dispatch(new StartDrawCard(playerId, _store.Value.BlackjackInfo.Id, _store.Value.BlackjackInfo.IdRequest));
        }

    }

    private void OnClickPlantarse()
    {
        if (_store.Value.BlackjackInfo != null && _store.Value.Request != null)
        {
            if (_store.Value.Loader.IsChallenger)
            {
                //si es retador seteo los datos con el id del retador
                _dispatcher.Dispatch(new StartStandHand(_store.Value.BlackjackInfo.Id,_store.Value.Request.PlayerId, _store.Value.BlackjackInfo.IdRequest));

            }
            else
            {
                if (!string.IsNullOrEmpty(_store.Value.Request.AcceptedPlayerId))
                {
                    _dispatcher.Dispatch(new StartStandHand(_store.Value.BlackjackInfo.Id, _store.Value.Request.AcceptedPlayerId, _store.Value.BlackjackInfo.IdRequest));
                }
            }
        }        
    }

    private void OnClickReinicarMano()
    {
        if (_store.Value.BlackjackInfo != null && _store.Value.Request != null)
        {
            if (_store.Value.Loader.IsChallenger)
            {
                //si es retador seteo los datos con el id del retador
                _dispatcher.Dispatch(new StartResetHand(_store.Value.BlackjackInfo.Id, _store.Value.Request.PlayerId));
            }
            else
            {
                if (!string.IsNullOrEmpty(_store.Value.Request.AcceptedPlayerId))
                {
                    _dispatcher.Dispatch(new StartResetHand(_store.Value.BlackjackInfo.Id, _store.Value.Request.AcceptedPlayerId));
                }
            }
        }
    }

    //TODO: Arreglar la logica del juego ahora solo va escuchar su mano para toda  operacion
    //Las unicas que van a escuchar los dos jugadores es plantarseResult para que consulte ambas manos
    //y cambio de turno


}